# Joint scRNA-seq and scATAC-seq Quality Control Pipeline Summary

## Overview
This pipeline performs comprehensive quality control analysis for paired single-cell RNA-seq (scRNA-seq) and single-cell ATAC-seq (scATAC-seq) data. The analysis includes individual QC for each modality followed by integrated filtering and visualization.

## Required Libraries
- **Seurat ecosystem**: Seurat, Signac
- **Genomic annotations**: EnsDb.Hsapiens.v86, BSgenome.Hsapiens.UCSC.hg38, AnnotationHub
- **Data processing**: Matrix, dplyr, data.table, vroom, GenomicRanges
- **Quality control**: DoubletFinder, scDblFinder
- **Visualization**: ggplot2, patchwork, corrplot
- **Clustering**: ConsensusClusterPlus, aricode

## scATAC-seq Quality Control

### Data Setup and Preparation
- Load 10X filtered feature-barcode matrix (HDF5 format)
- Extract ATAC peaks and fragment data
- Filter data by sample IDs (suffix "-2")
- Prepare repetitive elements annotation from AnnotationHub
- Parse peak coordinates into GRanges objects

### Peak-Level Quality Control

#### Cell-Level Peak Metrics
- **Standard chromosome ratio**: Proportion of peaks in chr1-22, chrX
- **Mitochondrial peaks**: Peaks overlapping chrM/chrMT
- **Blacklisted regions**: Peaks in ENCODE blacklisted regions
- **Repetitive elements analysis**:
  - High confidence removes: Simple repeats, low complexity, satellites, RNA genes
  - Moderate removes: LINEs, SINEs, LTRs
  - Keep types: DNA transposons, rolling circle elements
  - Individual repeat type analysis for all categories

#### Peak-Level Summary Metrics
- Peak expression statistics (cell ratio, read counts, width)
- Genomic region overlap ratios
- Binary indicators for each peak's genomic context

### Fragment-Level Quality Control
- **Fragment processing**: Create GRanges from fragment TSV files
- **Overlap analysis**: Fragments within peaks, blacklisted regions, standard chromosomes
- **Repetitive elements**: Fragment overlaps with all repeat categories
- **Signal quality metrics**:
  - Nucleosome signal calculation
  - TSS enrichment scores
  - Fragment count and peak accessibility metrics

### ATAC-seq Doublet Detection
- Use scDblFinder for doublet identification
- Aggregate features approach with normalization
- Generate doublet scores and classifications

### ATAC-seq Filtering Criteria
**Cell filtering thresholds**:
- Fragments > 1,000
- Peak reads: 1,000 - 100,000
- Accessible peaks > 1,000
- Fragment-in-peaks ratio > 0.4 (optional)
- Blacklist fragment ratio < 0.01
- Standard chromosome fragment ratio > 0.95
- Mitochondrial fragment ratio < 0.05
- Nucleosome signal < 2
- TSS enrichment > 1
- Singlet classification only

**Peak filtering thresholds**:
- Cell expression ratio > 0.01
- Minimum 5 expressing cells
- Minimum 100 reads
- Standard chromosomes only
- No blacklisted regions
- No mitochondrial peaks

## scRNA-seq Quality Control

### Data Setup
- Load 10X gene expression data
- Create Seurat object with RNA assay
- Calculate basic QC metrics

### Cell-Level RNA Metrics
- **UMI counts**: Total UMI per cell
- **Gene counts**: Unique genes per cell
- **Mitochondrial ratio**: Percentage of mitochondrial gene expression
- **Gene complexity**: log10(genes per UMI) ratio

### Gene-Level RNA Metrics
- **Cell expression**: Number and ratio of cells expressing each gene
- **Total counts**: Aggregate expression per gene
- **Genomic location**: Standard chromosomes vs mitochondrial genes

### RNA-seq Doublet Detection
- Standard Seurat processing (normalization, scaling, PCA, UMAP, clustering)
- DoubletFinder parameter optimization
- Multiplet rate estimation based on cell recovery
- Homotypic doublet proportion modeling

### RNA-seq Filtering Criteria
**Cell filtering thresholds**:
- UMI counts > 500
- Gene counts > 300
- Mitochondrial ratio < 0.25
- Gene complexity > 0.8
- Singlet classification only

**Gene filtering thresholds**:
- Cell expression ratio > 0.01
- Minimum 10 expressing cells
- Minimum 10 total counts
- Standard chromosomes only
- No mitochondrial genes

## Integrated Quality Control

### Cross-Modal Filtering
- Apply both RNA-seq and ATAC-seq cell filters
- Retain cells passing both modality criteria
- Create filtered count matrices for both assays

### Final Seurat Object Creation
- Combined RNA and ATAC assays
- Chromatin assay with fragment information
- Gene annotation integration
- Sample metadata preservation

### Quality Control Visualization

#### Individual Modality Plots
**ATAC-seq visualizations**:
- Fragment and peak distribution plots
- Genomic region overlap summaries
- Repetitive element analysis plots
- Signal quality metrics (TSS, nucleosome)

**RNA-seq visualizations**:
- UMI and gene count distributions
- Mitochondrial ratio plots
- Gene complexity analysis
- Correlation plots (UMI vs genes)

#### Integrated Summary Plots
- Before/after filtering comparisons
- Multi-panel summary visualizations
- Combined QC metric distributions

## Output Files

### Quality Control Data
- `cell_level_peak_qc.csv`: Peak-based cell metrics
- `cell_level_frag_qc.csv`: Fragment-based cell metrics
- `cell_level_doublet_qc.csv`: ATAC doublet results
- `cell_level_rna_qc.csv`: RNA-based cell metrics
- `peak_level_peak_qc.csv`: Individual peak annotations
- `peak_level_peak_qc_summary.csv`: Peak-level summaries

### Filtering Results
- `df_cell_atac_keep.csv`: ATAC cell filter results
- `df_peak_atac_keep.csv`: Peak filter results
- `df_cell_rna_keep.csv`: RNA cell filter results
- `df_gene_rna_keep.csv`: Gene filter results
- `df_integrated_qc_summary.csv`: Final filtering summary

### Final Object
- `seuratObj_filtered.rds`: Filtered Seurat object with both modalities

## Key Analysis Features

### Comprehensive Repetitive Element Analysis
- Systematic categorization of genomic repeats
- Both peak and fragment-level overlap analysis
- Individual repeat type quantification
- Quality-based repeat classification

### Multi-Modal Integration
- Cross-modality cell filtering
- Consistent quality thresholds
- Integrated doublet detection
- Combined visualization approaches

### Robust Statistical Filtering
- Evidence-based threshold selection
- Multiple quality metric integration
- Conservative filtering approach
- Comprehensive documentation

### Scalable Processing
- Chunked file reading for large datasets
- Memory-efficient operations
- Parallel processing compatibility
- Modular function design

## Technical Considerations

### Performance Optimization
- Memory management with garbage collection
- Efficient sparse matrix operations
- Chunked processing for large fragment files
- Vectorized genomic operations

### Quality Control Stringency
- Multiple independent quality metrics
- Conservative filtering thresholds
- Cross-validation between modalities
- Comprehensive repeatability analysis

### Visualization Standards
- Consistent plotting themes
- Publication-ready figures
- Multi-panel integration
- Statistical threshold indicators

# Appendix 1: Repetitive Elements Classification

## Overview
This appendix provides detailed information about the repetitive elements classification system used in the scATAC-seq quality control pipeline. The classification is based on RepeatMasker annotations and follows established genomic repeat categorization standards.

## Repetitive Elements Categories (optional for QC)

### High Confidence Removal Elements
These repetitive elements are typically considered low-quality regions for chromatin accessibility analysis and are generally filtered out:

#### Simple Repeats (`Simple_repeat`)
- **Description**: Short tandem repeats and microsatellites
- **Characteristics**: Repetitive sequences of 1-6 base pairs repeated multiple times
- **Examples**: (CA)n, (AT)n, (GATA)n repeats
- **Impact on Analysis**: High false positive rates due to mapping ambiguity
- **Typical Abundance**: ~3% of human genome

#### Low Complexity Regions (`Low_complexity`)
- **Description**: Sequences with biased nucleotide composition
- **Characteristics**: Regions with limited sequence diversity (e.g., poly-A, poly-T runs)
- **Examples**: AAAAAA, TTTTTT, GCGCGC sequences
- **Impact on Analysis**: Poor sequence quality and mapping reliability
- **Typical Abundance**: ~1% of human genome

#### Satellite DNA (`Satellite`)
- **Description**: Highly repetitive DNA sequences in heterochromatin
- **Characteristics**: Large blocks of tandem repeats, often species-specific
- **Examples**: Alpha satellite DNA, beta satellite DNA
- **Impact on Analysis**: Centromeric regions with poor accessibility
- **Typical Abundance**: ~3% of human genome

#### RNA Genes
- **tRNA genes** (`tRNA`): Transfer RNA genes (~0.02% of genome)
- **rRNA genes** (`rRNA`): Ribosomal RNA genes (~0.5% of genome)
- **scRNA genes** (`scRNA`): Small cytoplasmic RNA genes (<0.01% of genome)
- **snRNA genes** (`snRNA`): Small nuclear RNA genes (~0.01% of genome)
- **srpRNA genes** (`srpRNA`): Signal recognition particle RNA genes (<0.01% of genome)

**Impact on Analysis**: These regions have distinct chromatin structure and may not represent typical regulatory elements.

### Moderate Removal Elements
These elements are more controversial for removal and depend on specific research questions:

#### Long Interspersed Nuclear Elements (`LINE`)
- **Description**: Autonomous retrotransposons capable of self-mobilization
- **Characteristics**: ~6-8 kb full-length elements with ORF1 and ORF2
- **Subtypes**: LINE-1 (L1), LINE-2 (L2), LINE-3 (L3)
- **Impact on Analysis**: May contain regulatory sequences but also mapping challenges
- **Typical Abundance**: ~20% of human genome

#### Short Interspersed Nuclear Elements (`SINE`)
- **Description**: Non-autonomous retrotransposons requiring LINE machinery
- **Characteristics**: ~100-300 bp elements derived from RNA polymerase III transcripts
- **Subtypes**: Alu elements (~11% of genome), MIR elements (~2% of genome)
- **Impact on Analysis**: Some Alu elements contain regulatory sequences
- **Typical Abundance**: ~13% of human genome

#### Long Terminal Repeats (`LTR`)
- **Description**: Retroviral-like elements with long terminal repeats
- **Characteristics**: ~1.5-11 kb elements with gag, pol, and env-like genes
- **Subtypes**: ERV (endogenous retroviruses), HERV (human endogenous retroviruses)
- **Impact on Analysis**: May contain ancient regulatory elements
- **Typical Abundance**: ~8% of human genome

### Keep Types Elements
These elements are often retained as they may contain functional regulatory sequences:

#### DNA Transposons (`DNA`)
- **Description**: Elements that transpose via DNA intermediates using transposase
- **Characteristics**: Terminal inverted repeats and transposase genes
- **Subtypes**: Tc1/mariner, hAT, Mu, piggyBac superfamilies
- **Impact on Analysis**: Often contain regulatory sequences and transcription factor binding sites
- **Typical Abundance**: ~3% of human genome

#### Rolling Circle Elements (`RC`)
- **Description**: Elements that replicate via rolling circle mechanism
- **Characteristics**: Single-stranded DNA intermediates and Rep proteins
- **Subtypes**: Helitron superfamily elements
- **Impact on Analysis**: May capture regulatory sequences during transposition
- **Typical Abundance**: <1% of human genome

## Quality Control Implementation

### Analysis Strategy
The pipeline implements a hierarchical filtering approach:

1. **Conservative Approach**: Remove high confidence elements first
2. **Research-Specific**: Evaluate moderate removal elements based on study goals
3. **Functional Retention**: Keep elements with potential regulatory function

### Peak-Level Analysis
For each peak, the pipeline calculates:
- **Binary overlap indicators**: Whether peak overlaps each repeat category
- **Overlap ratios**: Proportion of peaks overlapping each category
- **Individual classifications**: Specific repeat types within each peak

### Fragment-Level Analysis
For each cell, the pipeline quantifies:
- **Fragment counts**: Number of fragments overlapping each repeat category
- **Fragment ratios**: Proportion of total fragments in each category
- **Quality metrics**: Impact on overall accessibility signal

## Biological Considerations

### Chromatin Accessibility Context
- **Active Elements**: Some repetitive elements (especially DNA transposons) may contain active regulatory sequences
- **Heterochromatin**: Satellite DNA and some LINEs/SINEs are typically in closed chromatin
- **Evolutionary Remnants**: Many elements are inactive but may retain regulatory potential

### Research Applications
- **Developmental Studies**: May retain LTR elements for evolutionary regulatory analysis
- **Cancer Studies**: May focus on transposable element reactivation
- **Population Genetics**: May include repeat polymorphisms for ancestry analysis

### Technical Limitations
- **Mapping Ambiguity**: High sequence similarity causes alignment issues
- **PCR Bias**: Repetitive sequences may amplify preferentially
- **Sequencing Artifacts**: Short reads may misalign to repetitive regions

## Implementation Notes

### Data Source
- **Annotation Source**: AnnotationHub (RepeatMasker track AH99003)
- **Genome Build**: hg38/GRCh38
- **Chromosome Scope**: chr1-22, chrX, chrY, chrM only

### Filtering Logic
```r
# Example filtering logic from the pipeline:
high_confidence_removes <- c("Simple_repeat", "Low_complexity", "Satellite", 
                            "tRNA", "rRNA", "scRNA", "snRNA", "srpRNA")
moderate_removes <- c("LINE", "SINE", "LTR")
keep_types <- c("DNA", "RC")
```

### Quality Thresholds
The pipeline uses these repeat-based quality metrics for cell and peak filtering:
- Peaks with >95% coverage of standard chromosomes (non-repetitive)
- Fragments with minimal overlap to high-confidence removal elements
- Overall repetitive element burden assessment

## Recommendations

### Study-Specific Considerations
- **Epigenetic Studies**: Consider retaining LTR elements for regulatory analysis
- **Evolutionary Studies**: Include DNA transposons for ancient regulatory element analysis
- **Clinical Studies**: Use conservative filtering to reduce noise

### Quality Control Balance
- **Stringent Filtering**: Better signal-to-noise ratio but potential loss of regulatory information
- **Permissive Filtering**: Retains more biological signal but increases technical noise
- **Adaptive Filtering**: Adjust based on data quality and research questions